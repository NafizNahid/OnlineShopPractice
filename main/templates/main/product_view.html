{% extends 'main/base.html' %}

{% load static %}

{% block title %} {{product.name}} {% endblock %}

{% block css %}

    .product-view{
        margin-top: 20px;
        margin-bottom: 100px;
    }

{% endblock %}


{% block body %}

    <div class="container product-view">
        <div class="row">
            <div class="col-md-4 p-3">
                <img src="/media/{{product.image}}" alt="" height="225px"> 
            </div>
            <div class="col-md-6">
                <h4 id="name_pr{{product.code}}" class="card-title text-info">{{product.name}}</h4>
                <p>{{product.desc}}</p>
                <h5>Price: <span class="text-info"> BDT. <span id="price_pr{{product.code}}">{{product.price}} </span></span> </h5>
                <br>
                <span id="div_pr{{product.code}}" class="div_pr">
                    <button id="pr{{product.code}}" class="btn btn-info cart">Add to cart</button>
                </span>
                <br>
                <br>
                <div class="fb-like" data-href="http://127.0.0.1:8000/main/products/{{product.id}}" data-width="" data-layout="button_count" data-action="like" data-size="large" data-share="true"></div>
                <div class="fb-comments" data-href="http://127.0.0.1:8000/main/products/{{product.id}}" data-width="" data-numposts="10"></div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <!-- <script src="{% static 'main/js/category_view.js' %}"></script> --> <!--Required when using external js file from static-->
    
    <script>

        if(localStorage.getItem('cart') == null){
          var cart = {};
        }
        else {
            cart = JSON.parse(localStorage.getItem('cart'));
            updateCart(cart);
        }
        
        $('.div_pr').on('click', 'button.cart', function() {
            var idstr = this.id.toString();
            if (cart[idstr] != undefined) {
                qty = cart[idstr][0] + 1;
                
            } else {
                qty = 1;
                name = document.getElementById('name_' + idstr).innerHTML
                price = document.getElementById('price_' + idstr).innerHTML
                //console.log("name: ", name, "price: ", price);
                cart[idstr] = [qty, name, parseInt(price)];
            }
            updateCart(cart);
            //console.log(cart);
        });
        
        $('#popcart').popover();
        updatePopover(cart);
        
        function updatePopover(cart) {
            var popStr = "";
            popStr += "<h5> Your Shopping Cart </h5><div class='mx-2 my-2'>";
            var i = 1;
            for (var item in cart) {
                popStr += "<b>" + i + "</b>. ";
                popStr += cart[item][1] + "... Qty: " + cart[item][0] + '<br>' + " Price: " + cart[item][2]*cart[item][0] + '<br>';
                i += 1;
            }
            if( Object.keys(cart) != 0 ){
                popStr += "<a href='/main/checkout'><button class='btn btn-success' id ='checkout'>Checkout</button></a> <button class='btn btn-danger' onclick='clearCart()' id ='clearCart'>Clear Cart</button>     "
            }
            document.getElementById('popcart').setAttribute('data-content', popStr);
            $('#popcart').popover('toggle');
        }
        
        function clearCart() {
            cart = JSON.parse(localStorage.getItem('cart'));
            for (var item in cart) {
                if(document.getElementById('div_' + item)){
                    document.getElementById('div_' + item).innerHTML = '<button id="' + item + '" class="btn btn-info cart">Add To Cart</button>';
                }
            }
            localStorage.clear();
            cart = {};
            updateCart(cart);
        }
        
        function updateCart(cart) {
            var sum = 0;
            for (var item in cart) {
                sum = sum + cart[item][0]; //cart[item][0] gives the quantity of 'item'
                if(document.getElementById('div_' + item)){
                    document.getElementById('div_' + item).innerHTML = "<button id='minus" + item + "' class='btn btn-info minus'>-</button> <span id='val" + item + "''>" + cart[item][0] + "</span> <button id='plus" + item + "' class='btn btn-info plus'> + </button>";
                }
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            document.getElementById('cart').innerHTML = sum;
            updatePopover(cart);
        }
        
        // If plus or minus button is clicked, change the cart as well as the display value
        $('.div_pr').on("click", "button.minus", function() {
            a = this.id.slice(7, );
            cart['pr' + a][0] = cart['pr' + a][0] - 1;
            cart['pr' + a][0] = Math.max(0, cart['pr' + a][0]);
        
            if(cart['pr' + a][0]==0){
                document.getElementById('div_pr' + a).innerHTML = '<button id="pr' + a + '" class="btn btn-info cart">Add To Cart</button>';
                delete cart['pr' + a];
            }
            else {
                document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
            }
            updateCart(cart);
        });
        $('.div_pr').on("click", "button.plus", function() {
            a = this.id.slice(6, );
            cart['pr' + a][0] = cart['pr' + a][0] + 1;
            document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
            updateCart(cart);
        });
  
      </script>

{% endblock %}  